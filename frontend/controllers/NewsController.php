<?phpnamespace frontend\controllers;use common\helpers\ArrayHelper;use common\models\Article;use common\models\Category;use common\models\Keywords;use yii\web\Controller;use yii;use yii\helpers\Html;class NewsController extends CommonController{    /**     * @var string     */    public $layout = 'main';    public function behaviors()    {        return [            [                'class' => 'yii\filters\PageCache',                'duration' => 30*60,                'variations' => [                    Yii::$app->language,                    Yii::$app->request->get('page'),                    Yii::$app->request->get('id'),                ],            ],        ];    }    public function init()    {        parent::init(); // TODO: Change the autogenerated stub        Yii::$app->params['news_list_image']=true;    }    public function actionIndex()    {        $start = date('Y-m-d 00:00:00',strtotime("-365 day"));        $end = date('Y-m-d 23:59:00',strtotime("-1 day"));        $array=Yii::$app->db->createCommand("SELECT id,title FROM yii2_article WHERE `create_time` >= unix_timestamp( '$start' ) AND `create_time` <= unix_timestamp( '$end' ) and status=1 order by click desc limit 10")->queryAll();        $news_click=array();        foreach ($array as $key=>$value){            $news_click[$key]['title']=$value['title'];            $news_click[$key]['url']="/news/".$value['id'].".html";        }        Yii::$app->params['news_click']=$news_click;        $this->GetList();        $this->view->params['news_gs']=Article::find()->where(['category_id'=>35])            ->andWhere(['status'=>1])            ->andWhere(['like','np','c'])            ->orderBy('id DESC')->limit(10)->all();        $this->view->params['news_gs_f']=Article::find()->where(['category_id'=>35])            ->andWhere(['status'=>1])            ->andWhere(['like','np','h'])            ->orderBy('id DESC')->limit(10)->all();        return $this->render('index',['data'=>$this->data]);    }    public function actionGongsixinwen(){        Yii::$app->params['news_list_image']=false;        $this->GetList();        return $this->render('item',['data'=>$this->data]);    }    public function actionCase(){        $tree=ArrayHelper::CategoryList(28);        $this->data['tree']=$tree;        $this->Get_case_index();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionZhuanti(){        $this->GetList();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionHangyezixun(){        $this->GetList();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionZhishi(){        $this->GetList();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionChangjianwenti(){        $this->GetList();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionTezhong(){        $this->Get_case_list();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionJunjing(){        $this->Get_case_list();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionRobots(){        $this->Get_case_list();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionYiliao(){        $this->Get_case_list();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionGongye(){        $this->Get_case_list();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionYingji(){        $this->Get_case_list();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionShangyong(){        $this->Get_case_list();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionXiaofei(){        $this->Get_case_list();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionZhineng(){        $this->Get_case_list();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionShouchi(){        $this->Get_case_list();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionKantan(){        $this->Get_case_list();        return $this->render('case_index',['data'=>$this->data]);    }    public function actionDetail(){        parent::common();        if(Yii::$app->request->isGet){            $id=Yii::$app->request->get('id');            $item=Article::find()                ->where(['id'=>$id])                ->andWhere(['status'=>1])                ->one();            if (!isset($item)){                throw new \yii\web\NotFoundHttpException('The requested page does not exist.');            }            $item->click=$item->click+1;            $item->save();//             var_dump($item);            Yii::$app->params['breadcrumbs']=array();            Yii::$app->params['breadcrumbs'][]=Html::tag('a',"首页",['href'=>Yii::$app->homeUrl]);//面包屑            if ($item->category_id!=0){                $cat=\backend\models\Category::find()->select(['id','title','pid','name'])->where(['id'=>$item->category_id])->one();                if($cat->pid!=0){                    $ParCat=\backend\models\Category::find()->select(['id','title','pid','name'])->where(['id'=>$cat->pid])->one();                    if ($ParCat['name']=='case'){                        Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$ParCat['title'],['href'=>'/news/'.$ParCat['name'].'.html']);                    }else{                        Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$ParCat['title'],['href'=>'/'.$ParCat['name'].'/']);                    }                }                Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$cat['title'],['href'=>'/news/'.$cat['name'].'.html']);            }            if (strtotime('2018-9-6')<= $item['create_time']){                $item['content']=\common\helpers\Html::setAnchor($item['content'],1);            }else{                $item['content']=\common\helpers\Html::setAnchor($item['content']);            }            $this->data['detail']=$item;            //查询上-篇文章            $prev_article = Article::find()                ->andWhere(['status'=>1])                ->andFilterWhere(['>', 'id', $id])                ->andFilterWhere(['category_id'=>$item->category_id])                ->orderBy(['id' => SORT_ASC])                ->limit(1)                ->one();            //查询下-篇文章            $next_article = Article::find()                ->andWhere(['status'=>1])                ->andFilterWhere(['<', 'id', $id])                ->andFilterWhere(['category_id'=>$item->category_id])                ->orderBy(['id' => SORT_DESC])                ->limit(1)                ->one();            $this->data['prev_article'] = [                'url' => !is_null($prev_article) ? \Yii::$app->urlManager->createUrl(['news/detail','id'=>$prev_article->id]) : 'javascript:;',                'title' => !is_null($prev_article) ? $prev_article->title : '没有了',            ];            $this->data['next_article'] = [                'url' => !is_null($next_article) ? \Yii::$app->urlManager->createUrl(['news/detail','id'=>$next_article->id]) : 'javascript:;',                'title' => !is_null($next_article) ? $next_article->title : '没有了',            ];        }        $keywords_category=Keywords::find()->orderBy(['sort'=>SORT_ASC])->limit(28)->asArray()->all();        Yii::$app->params['keywords_category']=$keywords_category;//         echo 2;        return $this->render('detail',['data'=>$this->data]);    }    protected  function GetList(){        parent::common();        $list= Article::find()->select(['id','title','cover','description','create_time','click'])            ->where(['category_id'=>$this->lanmu['id']])            ->andWhere(['status'=>1])->orderBy('create_time desc');        $this->data['list']=$list;//获取列表下的所以文章        //        获取同等级栏目        $self_url='';        if ($this->lanmu['pid']!=0){            $category_dengji= Category::find()->where(['pid'=>$this->lanmu['pid']])->asArray()->all();            $this->data['category_dengji']=$category_dengji;//获取等级的栏目        }    }    protected function Get_case_list(){        parent::common();        $tree=ArrayHelper::CategoryList($this->lanmu['pid']);        $this->data['tree']=$tree;        $list= Article::find()->select(['id','title','cover','description','create_time','extend','click'])->where(['category_id'=>$this->lanmu['id'],'status'=>1])->orWhere(['category_id2'=>$this->lanmu['id'],'status'=>1]);//        $list_c=Article::find()->select(['id','title','cover','description','create_time','extend','click'])->where(['category_id'=>$this->lanmu['id']])//            ->andWhere(['status'=>1])//            ->andWhere(['like','np','c'])//            ->all();//        $this->data['list_c']=$list_c;        $this->data['list']=$list;//获取列表下的所以文章        $this->data['title'] = $this->lanmu['title'];    }    protected function Get_case_index(){        parent::common();        $lanmu_id_list=Category::find()->where(['pid'=>$this->lanmu['id']])->select(['id'])->asArray()->all();        $lanmu_id_list=ArrayHelper::getColumn($lanmu_id_list,'id');//        var_dump($lanmu_id_list);        $list= Article::find()->select(['id','title','cover','description','create_time','extend','click'])->where(['in','category_id',$lanmu_id_list])            ->andWhere(['status'=>1])            ->andWhere(['not like','np','a']);        $list_a= Article::find()->select(['id','title','cover','description','create_time','extend','click'])->where(['in','category_id',$lanmu_id_list])            ->andWhere(['status'=>1])            ->andWhere(['like','np','a'])            ->all();        $this->data['list_c']=$list_a;        $this->data['list']=$list;//获取列表下的所以文章        $this->data['title']='定制案例';//        var_dump($list);    }}