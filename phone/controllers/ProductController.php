<?php/** * Created by PhpStorm. * User: Administrator * Date: 2018/1/26 0026 * Time: 下午 1:59 */namespace phone\controllers;use common\helpers\ArrayHelper;use common\models\Attr;use common\models\AttrImages;use common\models\AttrImagesSelect;use common\models\AttrValue;use common\models\Category;use common\models\Images;use Faker\Provider\Image;use League\Glide\Http\NotFoundException;use Yii;use yii\helpers\Html;use common\models\Urlad;class ProductController extends CommonController{    public function init()    {        parent::init(); // TODO: Change the autogenerated stub    }    public function actionIndex(){        parent::common();        $lanmu_list=Category::find()->where(['pid'=>$this->lanmu['pid']]);        $this->view->params['atrr_kong']='';        $this->view->params['atrr_list']='';        $product_list=Images::find()->orderBy(['top'=>SORT_DESC,'id'=>SORT_DESC]);        $this->view->params['product_list']=$product_list;        $url=Yii::$app->request->url;        return $this->render('index',['data'=>$this->data]);    }    public function actionDetail(){        parent::common();        if(!empty(Yii::$app->request->get('id'))){            $item=Images::findOne(Yii::$app->request->get('id'));            if (!isset($item)){                throw new \yii\web\NotFoundHttpException('The requested page does not exist.');            }            $item->click=$item->click+1;            $item->save();//               var_dump($data);            Yii::$app->params['breadcrumbs']=array();            Yii::$app->params['breadcrumbs'][]=Html::tag('a',"首页",['href'=>Yii::$app->homeUrl]);//面包屑            $cat=\backend\models\Category::find()->select(['id','title','pid','name'])->where(['id'=>$item->category_id2])->one();            if($cat->pid!=0){                $ParCat=\backend\models\Category::find()->select(['id','title','pid','name'])->where(['id'=>$cat->pid])->one();                Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$ParCat['title'],['href'=>'/'.$ParCat['name'].'/']);            }            Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$cat['title'],['href'=>'/'.$cat['name'].'/']);            $this->data['id']=Yii::$app->request->get('id');            return $this->render('detail',['data'=>$this->data,'item'=>$item]);        }    }    public function actionMip(){        parent::common();        if(!empty(Yii::$app->request->get('id'))){            $item=Images::findOne(Yii::$app->request->get('id'));            if (!isset($item)){                throw new \yii\web\NotFoundHttpException('The requested page does not exist.');            }            $item->click=$item->click+1;            $item->save();//               var_dump($data);            Yii::$app->params['breadcrumbs']=array();            Yii::$app->params['breadcrumbs'][]=Html::tag('a',"首页",['href'=>Yii::$app->homeUrl]);//面包屑            $cat=\backend\models\Category::find()->select(['id','title','pid','name'])->where(['id'=>$item->category_id2])->one();            if($cat->pid!=0){                $ParCat=\backend\models\Category::find()->select(['id','title','pid','name'])->where(['id'=>$cat->pid])->one();                Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$ParCat['title'],['href'=>'/'.$ParCat['name'].'/']);            }            Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$cat['title'],['href'=>'/'.$cat['name'].'/']);            $this->data['id']=Yii::$app->request->get('id');            $imagesUrl=$item->imagesUrl;            if(count($imagesUrl)>0&&count($imagesUrl)<3){                $imagesUrl=array_slice($imagesUrl, 0,1);            }elseif(count($imagesUrl)>=3){                $imagesUrl=array_slice($imagesUrl, 0,3);            }            Yii::$app->params['imagesUrl']=$imagesUrl;            Yii::$app->params['detail']=$item;            $this->layout = 'main_mip';            return $this->render('detail_mip',['data'=>$this->data,'item'=>$item]);        }    }    public function common(){        parent::common();        self::get_product_list();        $lanmu_list=Category::find()->where(['pid'=>$this->lanmu['pid']]);        $lanmu_p=Category::find()->where(['id'=>$this->lanmu['pid']])->asArray()->one();        $this->view->params['lanmu_p']=$lanmu_p;        $this->view->params['lanmu_list']=$lanmu_list;        $this->view->params['action']=$this->lanmu['name'];        $this->view->params['atrr_kong']='';        $this->view->params['atrr_list']='';        $url=Yii::$app->request->url;        if(strpos($url,'mip') !==false){            $this->layout="main_list_mip";            return $this->render('/special/diwen_mip',['data'=>$this->data]);        }else{            return $this->render('/special/diwen',['data'=>$this->data]);        }    }    public function get_product_list(){//       echo ArrayHelper::isIn('1',[1,2]);        $choose=array();        $cate=Category::find()->where(['id'=>$this->lanmu['id']])->one();        $arrt=AttrImagesSelect::find()->where(['attr_value_id'=>Yii::$app->request->get('list')])->one();        if (!empty(Yii::$app->request->get('list'))){            $list= explode('-',Yii::$app->request->get('list'));            $array=array();            foreach ($list as $key=>$value){                $arrayItem=ArrayHelper::getColumn(AttrImagesSelect::find()->where(['attr_value_id'=>$value])->asArray()->all(),'images_id');//选择的属性对于的商品                if ($key>=1){                    $array=array_merge($array,$arrayItem);                    $array = ArrayHelper::FetchRepeatMemberInArray ($array);                }else{                    $array=array_merge($array,$arrayItem);                }            }            if (empty($array)){                throw new \yii\web\NotFoundHttpException('The requested page does not exist.');            }            $product_list=$cate->getImages($array)->select(['id','title','cover'])->orderBy(['top'=>SORT_DESC,'id'=>SORT_DESC]);            $imagesArray=$cate->getAttrImages($array)->with('attrName','attrValueName')->all();            //显示已选择的属性//            1.显示的属性id，根据属性类型的sort排序//            $choose =AttrValue::find()->where(['id'=>$list])->all();//            根据属性名的权重进行排序            $chooseOrderby=AttrValue::find()                ->from(AttrValue::tableName(). ' A')                ->select(['A.*'])                ->leftJoin(Attr::tableName(). ' B','A.attr_id=B.id')                ->where(['A.id'=>$list])                ->orderBy('B.sort')                ->all();            $choose=$chooseOrderby;        }else{            $product_list=$cate->getImages()->select(['id','title','cover'])->orderBy(['top'=>SORT_DESC,'id'=>SORT_DESC]);            $imagesArray=$cate->getAttrImages()->with('attrName','attrValueName')->all();        }        $chooseIdArray=array();        foreach ($choose as $k=>$v){//                $chooseArray=ArrayHelper::getValue($v,'id');            $chooseIdArray[$k]=$v->id;        }        $chooseId=ArrayHelper::array2string($chooseIdArray,'-');        $this->view->params['chooseIdArray'] =$chooseIdArray;        $this->view->params['chooseId'] =$chooseId;        $this->view->params['choose'] =$choose;//        var_dump($cate);        //处理这个属性标签//        var_dump($cate->getAttrImages()->all());        //显示所有属性        $attr_list=array();        $chushizhi='';        $index=-1;        //            选择的属性        $chooseArray=array();        foreach ($choose as $k=>$v){//                $chooseArray=ArrayHelper::getValue($v,'id');            $chooseArray[$k]=$v->attr->name;        }        foreach ($imagesArray as $value){            if (ArrayHelper::isIn($value->attrName->name,$chooseArray)){                continue;            }            if ($chushizhi!=$value->attrName){                $chushizhi=$value->attrName;                $index++;                $attr_list[$index]['attr']=$value->attrName->name;                $attr_list[$index]['sort']=$value->attrName->sort;            }            $valueArray=array();            $valueArray['name']=$value->attrValueName->name;            $valueArray['id']=$value->attrValueName->id;            $valueArray['sort']=$value->attrValueName->sort;            $attr_list[$index]['values'][]=$valueArray;        }        foreach ($attr_list as $key=>$value){            $attr_list[$key]['values']=ArrayHelper::list_sort_by( $value['values'],'sort');        }        $attr_list=ArrayHelper::list_sort_by($attr_list,'sort');//        var_dump($attr_list);        //处理商品列表//        $p_list=Images::find()////            ->with([////                'category'=>function ($query) {////                    $query->andWhere(['id' =>$this->lanmu['id']]);////                },////                'attrValue'=>function ($query) {////                    $query->andWhere(['attr_id' =>1]);////                },////            ])////            ->select(['id','title','cover'])->all();////          ;//        $p_list=Images::find()//            ->leftJoin('yii2_category_images', '`yii2_category_images`.`images_id` = `yii2_images`.`id`')//            ->where(['category.id' => 3])//            ->with('category')//定义的关联属性名称为blogs//            ->all();//          foreach ($p_list as $key=>$value){////              echo $key;//          }//        var_dump($choose);        $this->view->params['product_list']=$product_list;        $this->view->params['attr_list']=$attr_list;//        var_dump($attr_list);//        var_dump($cate->getAttr());//        SEO优化        if (!empty(Yii::$app->request->get('list'))) {            $choose_attrValue = '';            foreach ($choose as $key => $value) {                if ($key==0){                    $choose_attrValue=$value->name;                }else{                    $choose_attrValue = $choose_attrValue . ' ' . $value->name;                }            }            $choose_categoryValue = ' '.Yii::$app->params['lanmu']['title'];            $title = $choose_attrValue . $choose_categoryValue . '组生产厂家_锂离子电池定制/价格/品牌【钜大锂电】' ;            $keywords = $choose_attrValue . $choose_categoryValue . ',锂离子电池生产厂家';            $description = '东莞钜大锂电池公司，广东知名' . $choose_attrValue . $choose_categoryValue . '组生产厂家，按需定制大容量' . $choose_attrValue  . '锂离子电池价格/品牌/排名。16年专注锂电池定制，超可靠，超安全！！';            $this->view->params['meta_title'] = $title;            $this->view->params['keywords'] = $keywords;            $this->view->params['description'] = $description;        }    }}